# 장애 처리와 Microservice 분산 추적

## 1. Microservice 통신 시 연쇄 오류

- 마이크로서비스 간의 호출이 체인처럼 연결되어 있을 때, 한 서비스에서 장애가 발생하면 **연쇄적으로 오류가 발생할 수 있다**.
- 이런 상황을 방지하기 위해, **우회 로직이나 기본값 처리 등을 사전에 준비**해야 한다.
- 문제가 되었던 서비스가 복구되면, **정상적으로 다시 요청을 보낼 수 있도록 구현**해야 한다.

## 2. CircuitBreaker

- 장애가 발생하는 서비스에 대해 **반복적인 호출을 차단하는 역할**을 한다.
- 특정 서비스가 정상적으로 동작하지 않을 경우, **기본값 반환이나 다른 로직으로 우회**함으로써 전체 장애를 방지한다.
- CircuitBreaker의 상태
  - **Closed**: 서비스가 정상 작동 중이며, 요청이 그대로 전달된다.
  - **Open**: 서비스가 비정상 상태로 판단되며, **요청이 차단**되고 대체 로직을 수행한다.
  - Half-Open: 일정 시간 후 일부 요청을 테스트로 보내 상태 확인

## 3. Resilience4j

- Java 기반의 **경량 장애 복구 라이브러리**로, 다양한 장애 처리 기능을 지원한다.
- 주요 기능
  - **CircuitBreaker**: 장애 서비스로의 호출을 차단
  - **RateLimiter**: 초당 혹은 분당 호출 횟수를 제한
  - **Retry**: 실패 시 정해진 횟수만큼 재시도
  - **TimeLimiter**: 일정 시간 초과 시 타임아웃 처리
  - **Cache**: 응답 결과를 캐싱하여 재사용
- **가벼운 장애나 예외 상황에서도 시스템을 가용 상태로 유지**할 수 있도록 도와준다.

## 4. Microservice 분산 추적

- 마이크로서비스 환경에서는 하나의 요청이 여러 서비스를 거쳐 처리된다.
- 요청이 **어떤 마이크로서비스를 거쳐 갔는지 추적할 수 있어야 한다**.
- 이를 위해 서비스 간의 요청에 **공통된 트레이싱 정보(Trace ID, Span ID)**를 함께 전달해야 한다.
- 각 서비스는 이 정보를 로그나 추적 시스템(예: Zipkin, Jaeger 등)에 저장하여 요청의 흐름을 시각적으로 분석할 수 있다.
- 이를 통해 **병목 지점 분석, 장애 발생 지점 확인, 성능 개선** 등의 작업이 가능하다.

## 5. Zipkin

- Twitter에서 개발한 **오픈소스 분산 추적 시스템**이다.
- Google의 Dapper 논문에서 아이디어를 얻어 개발되었으며, **분산 환경에서 병목 현상 파악과 요청 흐름 분석에 유용하다**.
- 각 마이크로서비스에 걸쳐 전달되는 요청의 **시간 정보, 호출 순서, 지연 시간** 등을 수집하고 분석할 수 있다.
- 구성 요소
  - `Collector`: 서비스에서 전송된 추적 데이터를 수집한다.
  - `Query Service`: 수집된 데이터를 검색할 수 있도록 한다.
  - `Database`: 추적 데이터를 저장하는 저장소 역할을 한다.
  - `Web UI`: 수집된 데이터를 시각화하여 보여준다.

### 5.1 Span

- **하나의 요청에서 발생한 작업 단위**이다.
- 예: DB 쿼리 요청, 외부 API 호출 등
- 각각의 Span은 **고유한 64비트 ID**를 가진다.
- Span 간에는 **부모-자식 관계**를 가질 수 있다.

### 5.2 Trace

- 하나의 요청에서 발생한 **여러 Span의 집합**이다.
- **트리 구조로 구성**되며, 하나의 요청에 대해 **공통의 Trace ID**를 가진다.
- Trace를 통해 전체 요청의 흐름을 시간 순서대로 확인할 수 있다.

## 6. Spring Cloud Sleuth

- Spring Boot 애플리케이션에서 **Zipkin과의 연동을 지원하는 분산 추적 라이브러리**이다.
- **Trace ID와 Span ID를 자동으로 생성하고 전파**하여 요청의 흐름을 추적할 수 있게 한다.
- 로그에 Trace ID와 Span ID를 **자동으로 포함시켜 로그만으로도 흐름을 파악할 수 있게 한다**.
- 주요 지원 대상
  - `Servlet Filter`: HTTP 요청 처리 흐름 추적
  - `RestTemplate`: 외부 HTTP 요청 추적
  - `Scheduled Actions`: 스케줄링된 작업의 추적
  - `Message Channels`: 메시지 기반 통신 추적
  - `Feign Client`: 선언형 HTTP 클라이언트 요청 추적
