# VPC

## 1. 네트워크 기초

### 1.1. 사설망

- 한정된 IP 주소를 최대한 **활용하기** 위해 IP 주소를 **분할**하고자 만든 개념이다. IPv4 기준으로 최대 IP 개수는 약 **43억 개**(4,294,967,296)이다.
- 사설망 내부에는 외부 인터넷 망으로 통신이 불가능한 **사설 IP**로 구성된다.
- 외부로 통신할 때는 통신 가능한 **공인 IP**로 나누어 사용한다.
- 보통 하나의 망에는 사설 IP를 부여받은 기기들과 **NAT 기능**을 갖춘 **Gateway**로 구성된다.

| Class |     이름     |       IP address range        | 아이피 개수 | 서브넷 마스크 |
| :---: | :----------: | :---------------------------: | :---------: | :-----------: |
| **A** | 24-bit block |   10.0.0.0 ~ 10.255.255.255   | 16,777,216  |  (255.0.0.0)  |
| **B** | 20-bit block |  172.16.0.0 ~ 172.31.255.255  |   104,857   | (255.240.0.0) |
| **C** | 16-bit block | 192.168.0.0 ~ 192.168.255.255 |   65,536    | (255.255.0.0) |

### 1.2. NAT(Network Address Translation)

- 사설 IP가 공용 IP로 통신할 수 있도록 주소를 **변환**해 주는 방법이다.
- 3가지 종류가 있다.
  - **Dynamic NAT**: 1개의 사설 IP를 가용 가능한 공인 IP로 연결한다.
  - **Static NAT**: 하나의 사설 IP를 고정한 하나의 공인 IP로 연결한다.
  - **PAT(Port Address Translation)**: 많은 사설 IP를 하나의 공인 IP로 연결한다.

### 1.3. CIDR(Classless Inter Domain Routing)

- IP 주소의 영역을 여러 네트워크 영역으로 나누기 위해 IP를 **묶는 방식**이다. 여러 개의 사설망을 구축하기 위해 망을 나누는 방법이다.

#### CIDR Notation

- IP 주소의 **집합**이다.
- **네트워크 주소**와 **호스트 주소**로 구성된다.
- 각 호스트 주소 숫자만큼의 IP를 가진 네트워크 망 형성이 가능하다.
- **A.B.C.D/E** 방식이다.
  - **A, B, C, D**: 네트워크 주소 + 호스트 주소를 표시한다.
  - **E**: 0 ~ 32 범위이며, **네트워크 주소**가 몇 bit인지 표시한다.

#### CIDR Block

- **호스트 주소 비트**만큼 IP 주소를 보유 가능하다.
- **192.168.2.0/24**의 예시는 다음과 같다.

  - 네트워크 비트는 **24**이다.
  - 호스트 주소는 32 - 24 = **8**이다.
  - 즉 $2^8$ = **256개**의 IP 주소를 보유한다.
  - 192.168.2.0 ~ 192.168.2.255까지 총 **256개** 주소를 의미한다.

### 1.4. 서브넷

- **네트워크 안의 네트워크**이다.

- 큰 네트워크를 잘게 쪼갠 **단위**이다.
- 일정 IP 주소의 **범위**를 보유한다. 큰 네트워크에 부여된 IP 범위를 조금씩 잘라 작은 단위로 나눈 후 각 **서브넷**에 할당한다.

## 2. VPC(Virtual Private Cloud)

- 사용자의 AWS 계정 전용 **가상 네트워크**이다.
- VPC는 AWS 클라우드에서 다른 가상 네트워크와 논리적으로 **분리**되어 있다.
- **Amazon EC2** 인스턴스와 같은 AWS 리소스를 VPC에서 실행할 수 있다.
- **IP 주소 범위**와 VPC 범위를 설정하고 **서브넷**을 추가하고 **보안 그룹**을 연결한 다음 **라우팅 테이블**을 구성한다.
- **가상의 데이터 센터**이다.
- 원하는 대로 **사설망** 구축이 가능하며, 부여된 IP 대역을 분할하여 사용할 수 있다.
- **리전 단위**이다.
- **EC2**, **RDS**, **Lambda** 등의 AWS 컴퓨팅 서비스를 실행한다.
- 다양한 **서브넷** 구성과 **보안 설정**(IP Block, 인터넷에 노출되지 않는 EC2 구성)이 가능하다.

## 3. 서브넷(subnet)

- VPC의 **하위 단위**로 VPC에 할당된 IP를 더 작은 단위로 분할한 개념이다.
- 하나의 서브넷은 하나의 **가용 영역(AZ)** 안에 위치한다.
- **CIDR block range**로 IP 주소를 지정하며 **IPv4**, **IPv6**를 지원한다.
- IPv4의 경우 최소 **/28** CIDR 이상에서 최대 **/16**까지 가능하다.
- 즉 호스트 비트가 $32 - 28 = 4$이므로 $2^4 = 16$이고, 여기서 5개를 뺀 **최소 11개**의 IP를 보유한다.

### 3.1. AWS 서브넷의 IP 개수

- AWS의 사용 가능 IP 숫자는 **5개**를 제외하고 계산한다.
- **10.0.0.0/24**라면 다음과 같이 할당된다.
  - **10.0.0.0**: **네트워크 어드레스**이다.
  - **10.0.0.1**: **VPC Router**이다.
  - **10.0.0.2**: **DNS Server**이다.
  - **10.0.0.3**: **미래**에 사용을 위해 남겨둔 주소이다.
  - **10.0.0.255**: **네트워크 브로드캐스트 어드레스**이다(단, 브로드캐스트는 지원하지 않음).

### 3.2. VPC Router

- VPC에 있는 **가상의 라우터**로 서브넷에서 오고 가는 트래픽을 라우팅한다. 즉 모든 서브넷의 트래픽은 **VPC 라우터**를 거쳐서 목적지에 도달한다.
- VPC 생성 시 자동으로 생성되며 별도로 관리할 필요가 없다. 별도의 설정은 불가능하며 **Route Table**만 관리 가능하다.

#### 라우트 테이블(Route Table)

- VPC 라우터에서 트래픽이 어디로 가야 할지 알려주는 **이정표**이다.
- VPC 생성 시 **기본**으로 하나가 제공된다.
- 구성 요소
  - **Destination**: 트래픽이 가고자 하는 **주소**이다.
  - **Target**: 트래픽을 실제로 보내줄 **대상**이며, 논리적 리소스의 아이디로 표현된다(예: igw-1234).

### 3.3. 서브넷 종류

- **퍼블릭 서브넷**: 외부에서 **인터넷**을 통해 연결할 수 있는 서브넷이다.
  - **인터넷 게이트웨이**를 통해 외부의 인터넷과 연결되어 있으며, 안에 위치한 인스턴스에 **퍼블릭 IP** 부여가 가능하다.
  - **웹 서버**, **애플리케이션 서버** 등 유저에게 노출되어야 하는 인프라에 사용한다.
- **프라이빗 서브넷**: 외부에서 인터넷을 통해 연결할 수 **없는** 서브넷이다.
  - 외부 인터넷으로 경로가 없으며 **퍼블릭 IP** 부여가 불가능하다.
  - **데이터베이스**, **로직 서버** 등 외부에 노출될 필요가 없는 인프라에 사용한다.

#### 인터넷 게이트웨이

- VPC가 외부의 인터넷과 통신할 수 있도록 경로를 만들어주는 **리소스**이다.
- 기본적으로 **확장성**과 **고가용성**이 확보되어 있다.
- **IPv4**와 **IPv6**를 지원한다. IPv4의 경우 **NAT** 역할을 수행한다.
- **Route Table**에서 경로 설정 후에 접근 가능하다.
- **무료**이다.

### 3.4. 기본 VPC와 커스텀 VPC

- **기본 VPC**
  - AWS 계정 생성 시 **자동**으로 생성되어 있다.
  - 기본적으로 각 **AZ**마다 서브넷을 생성하며, 모든 서브넷에 **인터넷 접근**이 가능하다(퍼블릭 서브넷).
  - 다양한 AWS 서비스가 기본 VPC를 이용하기 때문에 삭제 시 여러 AWS 서비스의 사용에 **제약**이 생길 수 있다.
- **커스텀 VPC**
  - **직접 생성**하는 VPC이다.
  - 기본적으로 인터넷에 연결되어 있지 않다.
  - **인터넷 게이트웨이**와 **라우팅 설정** 없이는 퍼블릭 서브넷 생성이 불가능하다.
    - 즉 별도의 조치 없이 인터넷으로 연결 가능한 **EC2** 생성이 불가능하다.
