# CloudFormation

## 1. 인프라 구성의 역사

| 구분                        | 소요 시간       | 주요 작업                                                                          |
| :-------------------------- | :-------------- | :--------------------------------------------------------------------------------- |
| Pre-Cloud                   | 몇 주 ~ 몇 개월 | - 데이터 센터/서버 확보<br>- 네트워크 공사 및 기기 설치<br>- OS/프로그램 수동 설치 |
| Cloud                       | 몇 시간         | - 리소스 선별<br>- 데이터 입력 및 클릭 (반복)                                      |
| IaC(Infrastructure as Code) | 몇 분           | - 설정파일 업로드<br>- 끝                                                          |

### 1.1. IaC(Infrastructure as Code)

- 클라우드에서 인프라를 **코드**로 관리하는 방법이다.
- 장점
  - 항상 **일관된 아키텍처**를 구현한다.
    - **휴먼 에러**를 배제할 수 있다.
  - **재사용성**이 뛰어나다.
    - 일정 단위의 **모듈**로 만들어 다양한 프로젝트에서 재사용 가능하다.
    - 인프라의 구성을 다른 사람과 **공유**하거나 **복제** 가능하다.
  - **관리**가 용이하다.
    - 리소스의 **변경** 및 **이력 추적**이 가능하다.
    - **일괄 삭제**가 가능하다.
    - **Git** 등을 활용한 **형상 관리**가 가능하다.

## 2. CloudFormation

- AWS 리소스를 모델링하고 설정하여 리소스 관리 시간을 줄이고, 애플리케이션 실행에 더 많은 시간을 사용할 수 있도록 돕는 **서비스**이다.
- AWS의 IaC 서비스 이다.
- 주요 사용 사례
  - 인프라를 **자동**으로 프로비저닝하고 싶을 때
  - 인프라를 **재사용**하거나 **공유**하고 싶을 때
  - 정형화된 아키텍처를 **코드화**하여 관리하고 싶을 때
  - 인프라의 **프로비저닝** 및 **업데이트** 과정을 체계적으로 관리하고 싶을 때
- 코드 기반으로 AWS 인프라를 여러 리전에 자동으로 **프로비저닝**하거나 **업데이트**한다.
  - 프로비저닝 및 업데이트 과정에서 오류 발생 시 자동으로 **롤백(Rollback)** 된다.
- **JSON**과 **YAML** 형식을 지원하며, 재사용성 및 편의를 위한 수많은 기능을 포함한다.
- **커스텀 리소스**를 사용하여 거의 모든 작업을 수행할 수 있다.
  - 예: 슬랙 알림, 온프레미스 데이터 센터의 리소스 구성 등

### 2.1. CloudFormation 주요 개념

- **템플릿(Template)**: JSON 또는 YAML 형식의 텍스트 파일로 AWS 인프라를 구성하는 리소스들의 **청사진**이다.
  - 프로비저닝할 리소스를 **정의**하고 리소스 간의 **관계**를 정의한다.
  - 다양한 **섹션**과 기능들로 구성된다.
  - **재사용** 가능하다.
- **논리적 리소스**: 템플릿을 기반으로 실제 프로비저닝되는 리소스를 대표하는 **논리적 개념**이다.
  - 템플릿 + 사용자의 **파라미터**/프로비저닝 시점의 값들로 구성된다.
- **스택(Stack)**: CloudFormation으로 리소스를 프로비저닝할 때 관련된 리소스를 묶은 **단위**이다.
  - **스택 ID**와 **이름**으로 구분한다(ID는 글로벌 고유 값, 이름은 리전 단위 고유 값).
  - 논리적 리소스의 구성을 실제 리소스로 **반영**한다.
    - 즉 논리적 리소스가 변경되면 실제 **리소스**도 변경된다.
  - 삭제 시 스택 단위로 삭제 가능하며, 스택 삭제 시 **모든 리소스**가 삭제된다.

## 3. 템플릿(Template)

- JSON 또는 YAML 형식의 텍스트 파일로 AWS 인프라를 구성하는 리소스들의 **청사진**이다.
- **텍스트 파일**로서의 다음과 같은 특징을 가진다.
  - 에디터로 수정 가능하다.
  - 소스 컨트롤(Git 등)이 가능하다.
  - LLM으로 생성이 가능하다.
- 다양한 **섹션**과 **기능**으로 구성된다.
  - **Resources 섹션**은 필수이며 나머지는 선택이다.
  - **Resources**, **Parameters**, **Intrinsic Functions** 3가지 요소가 가장 기초 단위이다.
- 특수한 상황을 제외하고 스택을 생성하는 **IAM 사용자**의 권한을 활용하여 프로비저닝한다.

### 3.1. 템플릿 생성 시 목표

- 최대한 외부의 도움 없이 **스스로 동작**할 수 있어야 한다(**Portability**).
  - 예: EC2 AMI 기본 값으로 프로비저닝하는 리전의 Amazon Linux 2023 ID를 가져온다.
- **파라미터**를 통해 커스터마이징 가능하도록 설정하여 **범용성**을 확보해야 한다.
  - 예: 하나의 템플릿에 Prod/Dev 옵션에 따라 다르게 프로비저닝한다.
  - 예: EC2 인스턴스 타입 등을 입력받아 다양한 상황에 일괄적으로 사용할 수 있어야 한다.
- 가능한 **독립적**으로 만들어야 한다.
  - 추후 다른 스택에서 템플릿을 참조할 수 있도록 **모듈화**가 가능해야 한다.
