# 도메인 서비스

## 1. 여러 애그리거트가 필요한 기능

- 도메인 기능을 구현하다 보면, **하나의 애그리거트만으로 기능을 구현할 수 없는 경우**가 있다. 예를 들어, 최종 결제 금액을 계산하려면 상품, 주문, 할인 쿠폰, 회원 등 여러 애그리거트의 정보가 필요하다.
- 이처럼 여러 애그리거트가 필요한 기능을 **하나의 특정 애그리거트에 억지로 구현**해서는 안 된다.
- 만약 주문 애그리거트가 할인 정책까지 책임지게 되면, 새로운 할인 정책이 추가될 때마다 주문 애그리거트의 코드를 수정해야 한다. 이는 **애그리거트가 자신의 책임 범위를 넘어서는 기능**을 갖게 되는 것이다.
- 결과적으로 해당 애그리거트는 **코드가 복잡해지고 다른 애그리거트에 대한 의존이 높아져**, 결국 수정을 어렵게 만드는 원인이 된다.
- 이러한 문제를 해결하기 위해 사용하는 것이 바로 **도메인 서비스(Domain Service)** 이다.

## 2. 도메인 서비스

- **도메인 서비스(Domain Service)**는 하나의 애그리거트에 포함시키기 어려운, **도메인 영역의 로직을 표현**할 때 사용한다. 주로 아래와 같은 상황에서 사용된다.
  - **복잡한 계산 로직**: 여러 애그리거트의 상태를 참조해야 하거나, 하나의 애그리거트에 두기에는 너무 복잡한 계산 로직
  - **외부 시스템 연동**: 외부 시스템과의 연동이 필요한 도메인 로직

### 2.1. 계산 로직과 도메인 서비스

- 한 애그리거트에 넣기 애매한 도메인 개념을 **도메인 서비스를 통해 명시적으로 드러낼 수 있다**. 응용 서비스가 응용 로직을 다루는 것처럼, 도메인 서비스는 **순수한 도메인 로직**을 다룬다.
- 애그리거트나 밸류와 달리, 도메인 서비스는 **상태 없이(stateless) 로직만으로 구성**된다. 로직 수행에 필요한 상태는 모두 파라미터를 통해 전달받는다.
- 도메인 서비스는 **응용 서비스** 또는 **애그리거트**에 의해 호출될 수 있다.
- 가장 일반적인 방식은, 응용 서비스가 필요한 애그리거트들을 조회한 뒤, 이들을 **파라미터로 담아 도메인 서비스를 호출**하는 것이다.
- 또는, 특정 애그리거트의 메서드를 호출할 때 **도메인 서비스를 파라미터로 전달**하여, 애그리거트가 내부 로직 수행 시 도메인 서비스를 사용하게 할 수도 있다. 이때, 애그리거트가 도메인 서비스의 기능을 사용하는 것이지, **도메인 서비스를 필드로 주입받아 의존해서는 안 된다**. 도메인 서비스는 특정 기능 수행을 위해 **일시적으로 사용되는 도구**와 같기 때문이다.
- 트랜잭션 관리와 같은 **응용 로직은 도메인 서비스가 아닌, 응용 서비스의 책임**이다.

```java
// 애그리거트 내부
public class Order {
    // 도메인 서비스를 필드로 갖지 않음!

    // '총 결제 금액 계산' 기능이 필요할 때만 파라미터로 받아서 사용
    public Money calculatePayAmounts(DiscountCalculationService discountService) {
        // ...
        Money discount = discountService.calculateDiscount(this.orderLines, this.coupon);
        // ...
    }
}
```

### 2.2. 외부 시스템 연동과 도메인 서비스

- 외부 시스템과의 연동이 필요한 기능 또한 **도메인 서비스로 표현**할 수 있다.
- 이때 중요한 것은, 외부 시스템의 API를 호출하는 기술적인 관점이 아니라 **도메인 관점에서 인터페이스를 정의**해야 한다는 것이다. 예를 들어, '결제 API 호출'이 아니라 '결제를 요청한다'와 같이 도메인 용어로 인터페이스를 작성해야 한다.

### 2.3. 도메인 서비스의 패키지 위치

- 도메인 서비스는 도메인 로직을 표현하므로, **다른 도메인 구성요소(애그리거트, 밸류 등)와 동일한 패키지**에 위치하는 것이 기본이다.
- 만약 도메인 서비스의 개수가 많아 명시적인 구분이 필요하다면, `domain` 패키지 아래에 `domain.model`, `domain.service`와 같이 **역할별로 하위 패키지를 구성**할 수도 있다.

### 2.4. 도메인 서비스의 인터페이스와 클래스

- 도메인 서비스의 로직이 고정되어 있지 않거나, **외부 시스템 연동처럼 특정 구현 기술에 의존하는 경우**에는 인터페이스와 구현 클래스를 분리하는 것이 좋다.
- 이 경우, **도메인 영역에는 인터페이스만 위치**시키고, 실제 **구현 클래스는 인프라스트럭처 영역**에 둔다.
- 이를 통해 **도메인 영역이 특정 구현 기술에 종속되는 것을 방지**하고, 테스트가 용이한 구조를 만들 수 있다.
